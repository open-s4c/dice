name: Build and test Dice in smolBSD VM (NetBSD)
on:
  - push
  - pull_request

env:
  REGISTRY: ghcr.io

jobs:
  smolbsd-test:
    if: true
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/open-s4c/dice/smolbsd-ci:latest
      options: --privileged
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Tar example
        run: tar cf project.tar .

      - name: Create payload image
        run: .github/smol/scripts/pack-payload.sh payload.img .github/smol/run.sh project.tar

      - name: Run payload
        run: .github/smol/scripts/run-payload.sh /smolBSD cicd payload.img

      - name: Unpack payload
        run: .github/smol/scripts/unpack-payload.sh payload.img results

      - name: List files in unpacked image
        run: ls results

      - name: Ensure tests passed
        run: .github/smol/check-results.sh results
