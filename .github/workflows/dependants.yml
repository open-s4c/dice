name: Test Dice dependant against the current branch
on:
  - push
  - pull_request

env:
  OWNER: open-s4c

jobs:
  run-dependant-actions:
    strategy:
      fail-fast: false
      matrix:
        dependant: [dice-rs]
    runs-on: ubuntu-latest
    steps:
      - name: Trigger ${{ matrix.dependant }} workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PAT }}
          repository: ${{ OWNER }}/${{ matrix.dependant }}
          event-type: test-dice
          client-payload: >
            {
              "sha": "${{ github.sha }}",
              "attempt": "${{ github.run_attempt }}"
            }
      - name: Wait for ${{ matrix.dependant }} workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const owner = ${{ OWNER }};
            const repo = '${{ matrix.dependant }}';
            const sha = '${{ github.sha }}';
            const attempt = '${{ github.run_attempt }}';
            const checkId = `dice-${sha}-${attempt}`;
            const maxRetries = 60;
            const interval = 10000;

            let check;
            for (let i = 0; i < maxRetries; i++) {
              const response = await github.rest.checks.listForRef({
                owner,
                repo,
                ref: sha,
                per_page: 100
              });

              check = response.data.check_runs.find(c => c.name === checkId);

              if (check) {
                if (check.status === 'completed') break;
              }

              console.log(`Waiting for check ${checkId} in ${repo}...`);
              await new Promise(r => setTimeout(r, interval));
            }

            if (!check) {
              throw new Error(`Check ${checkId} not found in ${repo}`);
            }

            console.log(`Check conclusion: ${check.conclusion}`);

            if (check.conclusion !== 'success') {
              throw new Error(`Downstream workflow failed in ${repo}`);
            }
